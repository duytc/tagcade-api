imports:
    - { resource: services/tag.cache.manager.yml }

parameters:
    tagcade_app.event.update_cache: tagcade_app.event.update_cache

services:

    tagcade_app.event_listener.adtag_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\AdTagChangeListener
        arguments:
            - @event_dispatcher
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }
            - { name: doctrine.event_listener, event: preSoftDelete }

    tagcade_app.event_listener.adslot_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\AdSlotChangeListener
        arguments:
            - @event_dispatcher
        tags:
            - { name: doctrine.event_listener, event: postPersist }
            - { name: doctrine.event_listener, event: preUpdate }
            - { name: doctrine.event_listener, event: postUpdate }

    tagcade_app.event_listener.native_adslot_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\NativeAdSlotChangeListener
        arguments:
            - @event_dispatcher
        tags:
            - { name: doctrine.event_listener, event: postPersist }

    tagcade_app.event_listener.ronadslot_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\RonAdSlotChangeListener
        arguments:
            - @event_dispatcher
        tags:
            - { name: doctrine.event_listener, event: preSoftDelete }
            - { name: doctrine.event_listener, event: postPersist }
            - { name: doctrine.event_listener, event: preUpdate }
            - { name: doctrine.event_listener, event: postSoftDelete }
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    tagcade_app.event_listener.site_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\SiteChangeListener
        arguments:
            - @tagcade.worker.manager
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    tagcade_app.event_listener.channel_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\ChannelChangeListener
        arguments:
            - @tagcade.worker.manager
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    tagcade_app.event_listener.publisher_change_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\PublisherChangeListener
        arguments:
            - @tagcade.worker.manager
        tags:
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

#    tagcade_app.event_listener.ronadslot_segment_change_listener:
#        class: Tagcade\Bundle\AppBundle\EventListener\RonAdSlotSegmentChangeListener
#        arguments:
#            - @event_dispatcher
#        tags:
#            - { name: doctrine.event_listener, event: postPersist }
#            - { name: doctrine.event_listener, event: postSoftDelete }

    tagcade_app.event_listener.update_cache_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\UpdateCacheListener
        arguments:
            - @tagcade.cache.tag_cache_manager
        tags:
            - { name: kernel.event_listener, event: tagcade_app.event.update_cache, method: onUpdateCache }

    tagcade_app.event_listener.update_dynamic_ad_slot_cache_listener:
        class: Tagcade\Bundle\AppBundle\EventListener\UpdateDynamicAdSlotCacheListener
        arguments:
            - @event_dispatcher
        tags:
            - { name: doctrine.event_listener, event: postPersist }
            - { name: doctrine.event_listener, event: preUpdate }
            - { name: doctrine.event_listener, event: onFlush }
            - { name: doctrine.event_listener, event: postFlush }

    tagcade_app.service.core.ad_tag.ad_tag_position_editor:
        class: Tagcade\Service\Core\AdTag\AdTagPositionEditor
        arguments:
            - @service_container
            - @doctrine.orm.default_entity_manager
        calls:
            - [setValidator, ["@tagcade_api.service.tag_library.checksum_validator"]]

    tagcade_app.service.core.ad_tag.partner_tag_id_finder:
        class: Tagcade\Service\Core\AdTag\PartnerTagIdFinder
        arguments:
            - @tagcade.repository.ad_tag

    tagcade_app.service.core.ad_tag.partner_tag_id_matcher:
        class: Tagcade\Service\Core\AdTag\PartnerTagIdMatcher
        arguments:
            - %partner_tag_id.matching_config%
            - @monolog.logger

    tagcade_app.service.core.ad_network.ad_network_service:
        class: Tagcade\Service\Core\AdNetwork\AdNetworkService
        arguments:
            - @doctrine.orm.default_entity_manager

    tagcade_app.service.core.site.site_service:
        class: Tagcade\Service\Core\Site\SiteService
        arguments:
            - "@tagcade_app.service.core.ad_network.ad_network_service"
            - @tagcade.repository.site
            - @tagcade_user.domain_manager.sub_publisher

    tagcade_app.service.core.exchange.exchange_cache_updater:
        class: Tagcade\Service\Core\Exchange\ExchangeCacheUpdater
        arguments:
            - @tagcade_user.domain_manager.publisher
            - %rtb.exchanges%
    tagcade_app.service.core.excel_file_processing:
        class: Tagcade\Service\ExcelFileProcessing
        arguments:
            - @monolog.logger

    tagcade_app.service.core.site.bulk_upload:
        class: Tagcade\Service\Core\Site\SiteImportBulkData
        arguments:
            - @tagcade.domain_manager.site
            - @tagcade_app.service.core.display_ad_slot.bulk_upload
            - @tagcade_app.service.core.dynamic_ad_slot.bulk_upload
            - @tagcade_app.service.core.ad_tag.bulk_upload
            - %tc.bulk_upload.site.index%
            - @monolog.logger
    tagcade_app.service.core.display_ad_slot.bulk_upload:
            class: Tagcade\Service\Core\AdSlot\DisplayAdSlotImportBulkData
            arguments:
                - @tagcade_app.service.core.ad_tag.bulk_upload
                - @monolog.logger
                - %tc.bulk_upload.display_ad_slot.index%
                - @tagcade.domain_manager.library_ad_slot
                - @tagcade.domain_manager.display_ad_slot

    tagcade_app.service.core.dynamic_ad_slot.bulk_upload:
            class: Tagcade\Service\Core\AdSlot\DynamicAdSlotImportBulkData
            arguments:
                - @tagcade.domain_manager.dynamic_ad_slot
                - @tagcade.domain_manager.site
                - @tagcade.domain_manager.library_expression
                - @tagcade.domain_manager.library_ad_slot
                - @tagcade.domain_manager.ad_slot
                - @doctrine.orm.default_entity_manager
                - @tagcade_api.service.expression_in_js_generator
                - @monolog.logger
                - %tc.bulk_upload.dynamic_ad_slot%
    tagcade_app.service.core.ad_tag.bulk_upload:
            class: Tagcade\Service\Core\AdTag\AdTagImportBulkData
            arguments:
                - @tagcade.domain_manager.ad_network
                - @monolog.logger
                - %tc.bulk_upload.ad_tag.index%
                - @tagcade.domain_manager.library_ad_tag
                - @tagcade.domain_manager.ad_tag
